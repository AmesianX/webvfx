<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WebVfx: examples/transition-shader-pagecurl.html</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">WebVfx&#160;<span id="projectnumber">0.1.6-6-g5144893-dirty</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">examples/transition-shader-pagecurl.html</div>  </div>
</div>
<div class="contents">
<p>This is an example MLT transition implemented in HTML. It uses the WebVfx WebGL shader support framework to implement a 2D page curl transition using GLSL. The rendered video can be viewed here <a href="http://www.youtube.com/watch?v=wT1qA9Utvbk">demo/mlt/mlt_transition_shader_pagecurl_html</a></p>
<div class="fragment"><pre class="fragment">&lt;html&gt;
&lt;head&gt;
&lt;style type=<span class="stringliteral">&quot;text/css&quot;</span>&gt;
body, html {
    margin: 0;
    width: 100%;
    height: 100%;
}
<span class="preprocessor">#canvas {</span>
<span class="preprocessor"></span>    width: 100%;
    height: 100%;
}
&lt;/style&gt;

&lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span> src=<span class="stringliteral">&quot;qrc:/webvfx/script/shader.js&quot;</span>&gt;&lt;/script&gt;
&lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span> src=<span class="stringliteral">&quot;qrc:/webvfx/script/easing.js&quot;</span>&gt;&lt;/script&gt;

&lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;
function PageCurl() {
    this.shader = <span class="keyword">new</span> WebVfx.Shader(document.getElementById(<span class="stringliteral">&quot;canvas&quot;</span>),
                                    WebVfx.Shader.loadShader(<span class="stringliteral">&quot;pageCurl&quot;</span>));
    this.easeCurl = <span class="keyword">new</span> WebVfx.Easing.Sinusoidal(0, 1, 1);
}

PageCurl.prototype.render = function (time) {
    var shader = this.shader;
    shader.updateUniform(<span class="stringliteral">&quot;time&quot;</span>, this.easeCurl.easeOut(time));
    shader.updateUniform(<span class="stringliteral">&quot;sourceTex&quot;</span>,
                         webvfx.getImage(<span class="stringliteral">&#39;sourceImage&#39;</span>).toImageData());
    shader.updateUniform(<span class="stringliteral">&quot;targetTex&quot;</span>,
                         webvfx.getImage(<span class="stringliteral">&#39;targetImage&#39;</span>).toImageData());
    shader.render();
}

function init() {
    <span class="keywordflow">try</span> {
        resize();
        var pageCurl = <span class="keyword">new</span> PageCurl();
        webvfx.renderRequested.connect(pageCurl, PageCurl.prototype.render);
        webvfx.imageTypeMap = { <span class="stringliteral">&quot;sourceImage&quot;</span> : webvfx.SourceImageType,
                                <span class="stringliteral">&quot;targetImage&quot;</span> : webvfx.TargetImageType };
        webvfx.readyRender(<span class="keyword">true</span>);
    } <span class="keywordflow">catch</span> (e) {
        console.warn(e);
        webvfx.readyRender(<span class="keyword">false</span>);
    }
}

function resize() {
    var canvas = document.getElementById(<span class="stringliteral">&quot;canvas&quot;</span>);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

window.addEventListener(<span class="stringliteral">&quot;load&quot;</span>, init, <span class="keyword">false</span>);
window.addEventListener(<span class="stringliteral">&quot;resize&quot;</span>, resize, <span class="keyword">false</span>);
&lt;/script&gt;


&lt;!--
PageCurl fragment shader is based on code from http:<span class="comment">//labs.calyptus.eu/pagecurl/</span>
Copyright (c) 2010 Calyptus Life AB &lt;http:<span class="comment">//calyptus.eu&gt;</span>
Licensed under The MIT License:
http:<span class="comment">//www.opensource.org/licenses/mit-license.php</span>
--&gt;
&lt;script <span class="keywordtype">id</span>=<span class="stringliteral">&quot;pageCurl&quot;</span> type=<span class="stringliteral">&quot;x-shader/x-fragment&quot;</span>&gt;
precision mediump float;

varying vec2 texCoord;
uniform sampler2D sourceTex;
uniform sampler2D targetTex;
uniform <span class="keywordtype">float</span> time; <span class="comment">// Ranges from 0.0 to 1.0</span>

<span class="keyword">const</span> <span class="keywordtype">float</span> MIN_AMOUNT = -0.16;
<span class="keyword">const</span> <span class="keywordtype">float</span> MAX_AMOUNT = 1.3;
<span class="keywordtype">float</span> amount = time * (MAX_AMOUNT - MIN_AMOUNT) + MIN_AMOUNT;

<span class="keyword">const</span> <span class="keywordtype">float</span> PI = 3.141592653589793;

<span class="keyword">const</span> <span class="keywordtype">float</span> scale = 512.0;
<span class="keyword">const</span> <span class="keywordtype">float</span> sharpness = 3.0;

<span class="keywordtype">float</span> cylinderCenter = amount;
<span class="comment">// 360 degrees * amount</span>
<span class="keywordtype">float</span> cylinderAngle = 2.0 * PI * amount;

<span class="keyword">const</span> <span class="keywordtype">float</span> cylinderRadius = 1.0 / PI / 2.0;

vec3 hitPoint(<span class="keywordtype">float</span> hitAngle, <span class="keywordtype">float</span> yc, vec3 point, mat3 rrotation) {
    <span class="keywordtype">float</span> hitPoint = hitAngle / (2.0 * PI);
    point.y = hitPoint;
    <span class="keywordflow">return</span> rrotation * point;
}


vec4 antiAlias(vec4 color1, vec4 color2, <span class="keywordtype">float</span> distance) {
    distance *= scale;
    <span class="keywordflow">if</span> (distance &lt; 0.0) <span class="keywordflow">return</span> color2;
    <span class="keywordflow">if</span> (distance &gt; 2.0) <span class="keywordflow">return</span> color1;
    <span class="keywordtype">float</span> dd = pow(1.0 - distance / 2.0, sharpness);
    <span class="keywordflow">return</span> ((color2 - color1) * dd) + color1;
}

<span class="keywordtype">float</span> distanceToEdge(vec3 point) {
    <span class="keywordtype">float</span> dx = abs(point.x &gt; 0.5 ? 1.0 - point.x : point.x);
    <span class="keywordtype">float</span> dy = abs(point.y &gt; 0.5 ? 1.0 - point.y : point.y);
    <span class="keywordflow">if</span> (point.x &lt; 0.0) dx = -point.x;
    <span class="keywordflow">if</span> (point.x &gt; 1.0) dx = point.x - 1.0;
    <span class="keywordflow">if</span> (point.y &lt; 0.0) dy = -point.y;
    <span class="keywordflow">if</span> (point.y &gt; 1.0) dy = point.y - 1.0;
    <span class="keywordflow">if</span> ((point.x &lt; 0.0 || point.x &gt; 1.0) &amp;&amp; (point.y &lt; 0.0 || point.y &gt; 1.0)) <span class="keywordflow">return</span> sqrt(dx * dx + dy * dy);
    <span class="keywordflow">return</span> min(dx, dy);
}

vec4 seeThrough(<span class="keywordtype">float</span> yc, vec2 p, mat3 rotation, mat3 rrotation) {
    <span class="keywordtype">float</span> hitAngle = PI - (acos(yc / cylinderRadius) - cylinderAngle);
    vec3 point = hitPoint(hitAngle, yc, rotation * vec3(p, 1.0), rrotation);

    <span class="keywordflow">if</span> (yc &lt;= 0.0 &amp;&amp; (point.x &lt; 0.0 || point.y &lt; 0.0 || point.x &gt; 1.0 || point.y &gt; 1.0)) {
        <span class="keywordflow">return</span> texture2D(targetTex, texCoord);
    }

    <span class="keywordflow">if</span> (yc &gt; 0.0) <span class="keywordflow">return</span> texture2D(sourceTex, p);

    vec4 color = texture2D(sourceTex, point.xy);
    vec4 tcolor = vec4(0.0);

    <span class="keywordflow">return</span> antiAlias(color, tcolor, distanceToEdge(point));
}

vec4 seeThroughWithShadow(<span class="keywordtype">float</span> yc, vec2 p, vec3 point, mat3 rotation, mat3 rrotation) {
    <span class="keywordtype">float</span> shadow = distanceToEdge(point) * 30.0;
    shadow = (1.0 - shadow) / 3.0;
    <span class="keywordflow">if</span> (shadow &lt; 0.0) shadow = 0.0;
    <span class="keywordflow">else</span> shadow *= amount;

    vec4 shadowColor = seeThrough(yc, p, rotation, rrotation);
    shadowColor.r -= shadow;
    shadowColor.g -= shadow;
    shadowColor.b -= shadow;
    <span class="keywordflow">return</span> shadowColor;
}

vec4 backside(<span class="keywordtype">float</span> yc, vec3 point) {
    vec4 color = texture2D(sourceTex, point.xy);
    <span class="keywordtype">float</span> gray = (color.r + color.b + color.g) / 15.0;
    gray += (8.0 / 10.0) * (pow(1.0 - abs(yc / cylinderRadius), 2.0 / 10.0) / 2.0 + (5.0 / 10.0));
    color.rgb = vec3(gray);
    <span class="keywordflow">return</span> color;
}

vec4 behindSurface(<span class="keywordtype">float</span> yc, vec3 point, mat3 rrotation) {
    <span class="keywordtype">float</span> shado = (1.0 - ((-cylinderRadius - yc) / amount * 7.0)) / 6.0;
    shado *= 1.0 - abs(point.x - 0.5);

    yc = (-cylinderRadius - cylinderRadius - yc);

    <span class="keywordtype">float</span> hitAngle = (acos(yc / cylinderRadius) + cylinderAngle) - PI;
    point = hitPoint(hitAngle, yc, point, rrotation);

    <span class="keywordflow">if</span> (yc &lt; 0.0 &amp;&amp; point.x &gt;= 0.0 &amp;&amp; point.y &gt;= 0.0 &amp;&amp; point.x &lt;= 1.0 &amp;&amp; point.y &lt;= 1.0 &amp;&amp; (hitAngle &lt; PI || amount &gt; 0.5)){
        shado = 1.0 - (sqrt(pow(point.x - 0.5, 2.0) + pow(point.y - 0.5, 2.0)) / (71.0 / 100.0));
        shado *= pow(-yc / cylinderRadius, 3.0);
        shado *= 0.5;
    } <span class="keywordflow">else</span>
        shado = 0.0;

    <span class="keywordflow">return</span> vec4(texture2D(targetTex, texCoord).rgb - shado, 1.0);
}

<span class="keywordtype">void</span> main(<span class="keywordtype">void</span>) {
    <span class="keyword">const</span> <span class="keywordtype">float</span> angle = 30.0 * PI / 180.0;
    <span class="keywordtype">float</span> c = cos(-angle);
    <span class="keywordtype">float</span> s = sin(-angle);

    mat3 rotation = mat3(
        c, s, 0,
        -s, c, 0,
        0.12, 0.258, 1
    );

    c = cos(angle);
    s = sin(angle);

    mat3 rrotation = mat3(
        c, s, 0,
        -s, c, 0,
        0.15, -0.5, 1
    );

    vec3 point = rotation * vec3(texCoord, 1.0);

    <span class="keywordtype">float</span> yc = point.y - cylinderCenter;

    <span class="keywordflow">if</span> (yc &lt; -cylinderRadius) {
        <span class="comment">// Behind surface</span>
        gl_FragColor = behindSurface(yc, point, rrotation);
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span> (yc &gt; cylinderRadius) {
        <span class="comment">// Flat surface</span>
        gl_FragColor = texture2D(sourceTex, texCoord);
        <span class="keywordflow">return</span>;
    }

    <span class="keywordtype">float</span> hitAngle = (acos(yc / cylinderRadius) + cylinderAngle) - PI;

    <span class="keywordtype">float</span> hitAngleMod = mod(hitAngle, 2.0 * PI);
    <span class="keywordflow">if</span> ((hitAngleMod &gt; PI &amp;&amp; amount &lt; 0.5) || (hitAngleMod &gt; PI/2.0 &amp;&amp; amount &lt; 0.0)) {
        gl_FragColor = seeThrough(yc, texCoord, rotation, rrotation);
        <span class="keywordflow">return</span>;
    }

    point = hitPoint(hitAngle, yc, point, rrotation);

    <span class="keywordflow">if</span> (point.x &lt; 0.0 || point.y &lt; 0.0 || point.x &gt; 1.0 || point.y &gt; 1.0) {
        gl_FragColor = seeThroughWithShadow(yc, texCoord, point, rotation, rrotation);
        <span class="keywordflow">return</span>;
    }

    vec4 color = backside(yc, point);

    vec4 otherColor;
    <span class="keywordflow">if</span> (yc &lt; 0.0) {
        <span class="keywordtype">float</span> shado = 1.0 - (sqrt(pow(point.x - 0.5, 2.0) + pow(point.y - 0.5, 2.0)) / 0.71);
        shado *= pow(-yc / cylinderRadius, 3.0);
        shado *= 0.5;
        otherColor = vec4(0.0, 0.0, 0.0, shado);
    } <span class="keywordflow">else</span> {
        otherColor = texture2D(sourceTex, texCoord);
    }

    color = antiAlias(color, otherColor, cylinderRadius - abs(yc));

    vec4 cl = seeThroughWithShadow(yc, texCoord, point, rotation, rrotation);
    <span class="keywordtype">float</span> dist = distanceToEdge(point);

    gl_FragColor = antiAlias(color, cl, dist);
}
&lt;/script&gt;

&lt;/head&gt;
&lt;body&gt;
    &lt;canvas <span class="keywordtype">id</span>=<span class="stringliteral">&quot;canvas&quot;</span>&gt;&lt;/canvas&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div> </div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/>
<address class="footer"><small>Generated on Wed Jun 1 2011 11:11:25 for WebVfx using <a href="http://www.doxygen.org">Doxygen 1.7.4</a></small></address>
<address class="footer"><small>Copyright (c) 2011 Hewlett-Packard Development Company, L.P. All rights reserved. Use of this source code is governed by a BSD-style license that can be found in the LICENSE file.</small></address>
</body>
</html>
